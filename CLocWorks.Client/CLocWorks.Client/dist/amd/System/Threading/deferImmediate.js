/*!
 * @author electricessence / https://github.com/electricessence/
 * Licensing: MIT https://github.com/electricessence/TypeScript.NET/blob/master/LICENSE.md
 * Based on code from: https://github.com/kriskowal/q
 */
define(["require","exports","../Types","../Collections/LinkedNodeList","../Collections/Queue","../Disposable/ObjectPool"],function(e,n,t,o,i,s){"use strict";function r(){for(var e;e=m.first;){var n=e.task,t=e.domain,o=e.context,i=e.args;e.canceller(),t&&t.enter(),c(n,t,o,i)}for(var s;s=g.dequeue();)c(s);p=!1}function c(e,n,t,o){try{e.apply(t,o)}catch(i){if(d)throw n&&n.exit(),setTimeout(r,0),n&&n.enter(),i;setTimeout(function(){throw i},0)}n&&n.exit()}function u(){p||(p=!0,f())}function a(e,n,t){var o=v.take();return o.task=e,o.domain=d&&process.domain,o.context=n,o.args=t&&t.slice(),o.canceller=function(){if(!o)return!1;var e=!!m.removeNode(o);return v.add(o),o=null,e},m.addNode(o),u(),{cancel:o.canceller,dispose:function(){o&&o.canceller()}}}function l(e){g.enqueue(e),u()}var f,d=!1,p=!1,m=new o.LinkedNodeList,g=new i.Queue,v=new s.ObjectPool(40,function(){return{}},function(e){e.task=null,e.domain=null,e.context=null,e.args&&(e.args.length=0),e.args=null,e.canceller=null});if(n.deferImmediate=a,n.runAfterDeferred=l,t.Type.isObject(process)&&"[object process]"===process.toString()&&process.nextTick)d=!0,f=function(){process.nextTick(r)};else if("function"==typeof setImmediate)f="undefined"!=typeof window?setImmediate.bind(window,r):function(){setImmediate(r)};else if("undefined"!=typeof MessageChannel){var w=new MessageChannel;w.port1.onmessage=function(){f=k,w.port1.onmessage=r,r()};var k=function(){w.port2.postMessage(0)};f=function(){setTimeout(r,0),k()}}else f=function(){setTimeout(r,0)};Object.defineProperty(n,"__esModule",{value:!0}),n["default"]=a});
//# sourceMappingURL=deferImmediate.js.map
